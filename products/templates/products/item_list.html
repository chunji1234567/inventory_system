{% extends "products/base.html" %}
{% block title %}物品管理{% endblock %}

{% block content %}
<div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
  <div class="space-y-1">
    <h1 class="text-2xl font-semibold text-slate-900">物品管理</h1>
    <p class="text-sm text-slate-500">维护物品名称、单位与所属仓库</p>
  </div>

  <button id="btnNewItem"
    class="inline-flex items-center rounded-xl bg-slate-900 px-4 py-2 text-sm font-medium text-white shadow-lg shadow-slate-900/25 hover:bg-slate-800">
    + 新增物品
  </button>
</div>

<div class="mt-6 overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
  <table class="min-w-full divide-y divide-slate-200 text-sm">
    <thead class="bg-slate-50 text-xs font-semibold uppercase text-slate-500">
      <tr>
        <th class="px-4 py-3 text-left">名称</th>
        <th class="px-4 py-3 text-left">仓库</th>
        <th class="px-4 py-3 text-left">单位</th>
        <th class="px-4 py-3 text-left">状态</th>
        <th class="px-4 py-3 text-left">操作</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-slate-100 bg-white text-slate-800">
      {% for it in items %}
        <tr class="hover:bg-slate-50/70">
          <td class="px-4 py-3">{{ it.name }}</td>
          <td class="px-4 py-3 text-slate-500">
            {% if it.warehouse %}
              {{ it.warehouse.name }}
            {% else %}
              <span class="text-slate-400">未关联</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-slate-500">{{ it.get_unit_display }}</td>
          <td class="px-4 py-3">
            {% if it.is_active %}
              <span class="rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-medium text-emerald-700 ring-1 ring-emerald-200">启用</span>
            {% else %}
              <span class="rounded-full bg-slate-100 px-2.5 py-1 text-xs font-medium text-slate-600 ring-1 ring-slate-200">停用</span>
            {% endif %}
          </td>
          <td class="px-4 py-3">
            <div class="flex gap-2">
              <button type="button"
                class="rounded-xl border border-slate-300 bg-white px-3 py-1.5 text-xs shadow-sm hover:bg-slate-50"
                data-edit
                data-id="{{ it.id }}"
                data-name="{{ it.name }}"
                data-unit="{{ it.unit }}"
                data-active="{{ it.is_active|yesno:'1,0' }}"
                data-warehouse="{{ it.warehouse_id }}">
                编辑
              </button>

              <form method="post" action="{% url 'products:item_toggle_active' it.id %}">
                {% csrf_token %}
                <button type="submit"
                  class="rounded-xl px-3 py-1.5 text-xs font-medium
                  {% if it.is_active %}
                    border border-red-200 bg-red-50 text-red-700 hover:bg-red-100
                  {% else %}
                    border border-emerald-200 bg-emerald-50 text-emerald-700 hover:bg-emerald-100
                  {% endif %}">
                  {{ it.is_active|yesno:"停用,启用" }}
                </button>
              </form>
            </div>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="5" class="px-4 py-6 text-center text-slate-500">暂无物品</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal：新增 / 编辑 -->
<div id="backdrop" class="fixed inset-0 z-30 hidden bg-slate-900/40"></div>

<div id="modalItem"
  class="fixed left-1/2 top-10 z-40 hidden w-[520px] max-w-[calc(100%-24px)] -translate-x-1/2 rounded-2xl bg-white shadow-2xl">
  <div id="modalTitle" class="border-b px-5 py-3 font-semibold">新增物品</div>

  <form id="itemForm" method="post">
    {% csrf_token %}
    <div class="space-y-4 px-5 py-4">
      <label class="block text-sm font-medium">名称
        <input id="fName" name="name" required
          class="mt-1 w-full rounded-xl border px-3 py-2 text-sm">
      </label>
      <label class="block text-sm font-medium">单位
        <select id="fUnit" name="unit" required
          class="mt-1 w-full rounded-xl border px-3 py-2 text-sm">
          {% for value, label in units %}
            <option value="{{ value }}">{{ label }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="block text-sm font-medium">所属仓库
        <select id="fWarehouse" name="warehouse_id" required
          class="mt-1 w-full rounded-xl border px-3 py-2 text-sm">
          <option value="" disabled selected>请选择仓库</option>
          {% for wh in warehouses %}
            <option value="{{ wh.id }}">{{ wh.name }}</option>
          {% endfor %}
        </select>
      </label>
      <label class="flex items-center gap-2 text-sm">
        <input id="fActive" type="checkbox" name="is_active" class="rounded border-slate-300">
        启用
      </label>
    </div>
    <div class="flex justify-end gap-3 border-t px-5 py-3">
      <button type="button" onclick="closeAll()" class="rounded-xl border px-4 py-2 text-sm">取消</button>
      <button type="submit" class="rounded-xl bg-slate-900 px-4 py-2 text-sm text-white">保存</button>
    </div>
  </form>
</div>

<script>
  const backdrop = document.getElementById("backdrop");
  const modal = document.getElementById("modalItem");
  const title = document.getElementById("modalTitle");
  const form = document.getElementById("itemForm");

  const fName = document.getElementById("fName");
  const fUnit = document.getElementById("fUnit");
  const fWarehouse = document.getElementById("fWarehouse");
  const fActive = document.getElementById("fActive");

  function openModal() {
    backdrop.classList.remove("hidden");
    modal.classList.remove("hidden");
  }
  function closeAll() {
    backdrop.classList.add("hidden");
    modal.classList.add("hidden");
  }
  backdrop.onclick = closeAll;

  document.getElementById("btnNewItem").onclick = () => {
    title.textContent = "新增物品";
    form.action = "{% url 'products:item_create' %}";
    fName.value = "";
    if (fUnit.options.length > 0) fUnit.selectedIndex = 0;
    if (fWarehouse.options.length > 0) {
      fWarehouse.selectedIndex = 0;
    }
    fActive.checked = true;
    openModal();
  };

  document.querySelectorAll("[data-edit]").forEach(btn => {
    btn.onclick = () => {
      title.textContent = "编辑物品";
      form.action = `/items/${btn.dataset.id}/edit/`;
      fName.value = btn.dataset.name;
      fUnit.value = btn.dataset.unit;
      fWarehouse.value = btn.dataset.warehouse || "";
      fActive.checked = (btn.dataset.active === "1");
      openModal();
    };
  });
</script>
{% endblock %}
