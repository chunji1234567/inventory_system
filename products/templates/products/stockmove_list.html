{% extends "products/base.html" %}
{% block title %}库存流水{% endblock %}

{% block content %}
<div class="flex flex-col gap-2">
  <h1 class="text-2xl font-semibold text-slate-900">库存流水</h1>
  <p class="text-sm text-slate-500">查询任意仓库、物品的入库/出库记录</p>
</div>

{% with current_move_type=move_type|default:'ALL' %}
<form id="stockmoveFilterForm" class="mt-6 flex flex-wrap items-end gap-3 rounded-2xl border border-slate-200 bg-white p-4 shadow-sm" method="get">
  <label class="flex min-w-[180px] flex-1 flex-col gap-1 text-sm font-medium text-slate-600">
    <span>仓库</span>
    <select name="warehouse_id"
      class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-200">
      <option value="">全部仓库</option>
      {% for w in warehouses %}
        <option value="{{ w.id }}" {% if warehouse_id == w.id|stringformat:"s" %}selected{% endif %}>
          {{ w.name }}
        </option>
      {% endfor %}
    </select>
  </label>

  <label class="flex min-w-[200px] flex-1 flex-col gap-1 text-sm font-medium text-slate-600">
    <span>物品</span>
    <select name="item_id"
      class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-200">
      <option value="">全部物品</option>
      {% for it in items %}
        <option value="{{ it.id }}" {% if item_id == it.id|stringformat:"s" %}selected{% endif %}>
          {{ it.name }}
        </option>
      {% endfor %}
    </select>
  </label>

  <label class="flex min-w-[200px] flex-1 flex-col gap-1 text-sm font-medium text-slate-600">
    <span>合作方</span>
    <select name="partner_id"
      class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-200">
      <option value="">全部合作方</option>
      {% for partner in partners %}
        <option value="{{ partner.id }}" {% if partner_id == partner.id|stringformat:"s" %}selected{% endif %}>
          {{ partner.name }}
        </option>
      {% endfor %}
    </select>
  </label>

  <label class="flex min-w-[220px] flex-1 flex-col gap-1 text-sm font-medium text-slate-600">
    <span>关键字</span>
    <input type="text" name="q" placeholder="搜索物品/仓库/备注/单号" value="{{ q|default:'' }}"
      class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm placeholder:text-slate-400 focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-200">
  </label>

  <div class="flex min-w-[260px] flex-1 flex-col gap-1 text-sm font-medium text-slate-600">
    <span>日期范围</span>
    <div class="flex gap-2">
      <input type="date" name="start_date" value="{{ start_date|date:'Y-m-d' }}"
        class="w-1/2 rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-200">
      <input type="date" name="end_date" value="{{ end_date|date:'Y-m-d' }}"
        class="w-1/2 rounded-xl border border-slate-300 bg-white px-3 py-2 text-sm text-slate-700 shadow-sm focus:border-slate-500 focus:outline-none focus:ring-2 focus:ring-slate-200">
    </div>
  </div>

  <div class="flex flex-col gap-2 text-sm font-medium text-slate-600">
    <span>类型</span>
    <div class="flex overflow-hidden rounded-2xl border border-slate-200 bg-slate-50 text-xs font-semibold text-slate-500 shadow-inner">
      {% for opt in move_type_options %}
        <label class="flex-1 cursor-pointer px-4 py-2 text-center transition {% if opt.active %}bg-white text-slate-900 shadow{% else %}hover:text-slate-900{% endif %}">
          <input type="radio" name="move_type" value="{{ opt.value }}" class="sr-only" {% if opt.active %}checked{% endif %}>
          {{ opt.label }}
        </label>
      {% endfor %}
    </div>
  </div>

  <div class="flex items-center gap-2">
    <button type="submit"
      class="inline-flex items-center rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-400">
      筛选
    </button>
    <a href="{% url 'products:stockmove_list' %}"
      class="inline-flex items-center rounded-xl border border-transparent bg-slate-100 px-4 py-2 text-sm font-medium text-slate-700 transition hover:bg-slate-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-400">
      重置
    </a>
    {% with request.GET.urlencode as current_qs %}
      <a href="{% url 'products:stockmove_export' %}{% if current_qs %}?{{ current_qs }}{% endif %}"
        class="inline-flex items-center rounded-xl border border-slate-300 bg-slate-50 px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-white focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-slate-400">
        导出结果
      </a>
    {% endwith %}
  </div>
</form>
{% endwith %}

<div class="mt-6 overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm">
  <table class="min-w-full divide-y divide-slate-200 text-sm">
    <thead class="bg-slate-50 text-left text-xs font-semibold uppercase tracking-wide text-slate-500">
      <tr>
        <th class="px-4 py-3">时间</th>
        <th class="px-4 py-3">仓库</th>
        <th class="px-4 py-3">物品</th>
        <th class="px-4 py-3">合作方</th>
        <th class="px-4 py-3">类型</th>
        <th class="px-4 py-3 text-right">数量</th>
        <th class="px-4 py-3">单号/来源</th>
        <th class="px-4 py-3">备注</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-slate-100 text-slate-800">
      {% for m in page_obj %}
        <tr class="transition hover:bg-slate-50/60">
          <td class="px-4 py-3 text-slate-600">{{ m.created_at|date:"Y-m-d H:i" }}</td>
          <td class="px-4 py-3">{{ m.warehouse.name }}</td>
          <td class="px-4 py-3">
            <div class="font-medium text-slate-900">{{ m.item.name }}</div>
          </td>
          <td class="px-4 py-3 text-slate-600">{{ m.partner.name|default:"-" }}</td>
          <td class="px-4 py-3">
            {% if m.move_type == 'INBOUND' %}
              <span class="inline-flex items-center rounded-full bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700">入库</span>
            {% elif m.move_type == 'OUTBOUND' %}
              <span class="inline-flex items-center rounded-full bg-red-50 px-3 py-1 text-xs font-semibold text-red-700">出库</span>
            {% else %}
              <span class="inline-flex items-center rounded-full bg-amber-50 px-3 py-1 text-xs font-semibold text-amber-700">调整</span>
            {% endif %}
          </td>
          <td class="px-4 py-3 text-right font-semibold text-slate-900">{{ m.quantity }}</td>
          <td class="px-4 py-3 text-slate-600">{{ m.reference|default:"" }}</td>
          <td class="px-4 py-3 text-slate-600">{{ m.note|default:"" }}</td>
        </tr>
      {% empty %}
        <tr>
          <td colspan="8" class="px-4 py-6 text-center text-slate-500">暂无流水</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if page_obj.paginator.num_pages > 1 %}
  <div class="mt-4 flex items-center justify-between rounded-2xl border border-slate-200 bg-white px-5 py-3 text-sm text-slate-600">
    <div>共 {{ page_obj.paginator.count }} 条记录</div>
    <div class="flex items-center gap-2">
      {% if page_obj.has_previous %}
        <a class="rounded-lg border border-slate-200 px-3 py-1 hover:bg-slate-50"
          href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.previous_page_number }}">上一页</a>
      {% endif %}
      <span>第 {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} 页</span>
      {% if page_obj.has_next %}
        <a class="rounded-lg border border-slate-200 px-3 py-1 hover:bg-slate-50"
          href="?{% if query_string %}{{ query_string }}&{% endif %}page={{ page_obj.next_page_number }}">下一页</a>
      {% endif %}
    </div>
  </div>
{% endif %}

<script>
  (function () {
    const form = document.getElementById("stockmoveFilterForm");
    if (!form) return;
    const radios = form.querySelectorAll("input[name='move_type']");
    radios.forEach((radio) => {
      radio.addEventListener("change", () => {
        form.requestSubmit();
      });
    });
  })();
</script>
{% endblock %}
